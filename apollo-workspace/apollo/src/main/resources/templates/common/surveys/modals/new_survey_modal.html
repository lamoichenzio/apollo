<html xmlns:th="http://www.thymeleaf.org">

<body>
    <!-- MODAL NEW SURVEY -->
    <div class="modal fade" id="modal-create-new-survey" tabindex="-1" role="dialog" aria-hidden="true"
        th:fragment="surveyForm">

        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <div class="modal-title align-items-center">
                        <!-- MODAL TITLE -->
                        <h6 th:if="${#request.getRequestURI().endsWith('create')}" class="mb-0" th:text="#{survey.create}"></h6>
                        <h6 th:if="${#request.getRequestURI().endsWith('update')}" class="mb-0" th:text="#{survey.edit}"></h6>
                    </div>
                </div>

                <form id="survey_form" th:action="${#request.getRequestURI()}" enctype="multipart/form-data"
                  th:object="${survey}" class="form-horizontal" method="post">

                    <!-- update case -->
                    <input th:if="${survey.id != null}" type="hidden" name="id" th:value="${survey.id}" th:field="*{id}" />
                    <input th:if="${survey.user != null}" type="hidden" name="user" th:value="${survey.user}" th:field="*{user}" />
                    
                    <div class="modal-body">

                        <!-- TITLE -->
                        <div class="form-group">
                            <label for="name" class="form-control-label"
                                th:text="#{survey.name}"></label>
                            <input type="text" th:field="*{name}" class="form-control" maxlength="50" required/>
                            <span th:if="${#fields.hasErrors('name')}"
                                th:each="err: ${#fields.errors('name')}" th:utext="${err}"></span>
                        </div>

                        <!-- DESCRIPTION -->
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="description" class="form-control-label"
                                        th:text="#{survey.description}"></label>
                                    <textarea class="form-control" data-toggle="autosize" rows="1" th:field="*{description}"></textarea>
                                    <span th:if="${#fields.hasErrors('description')}"
                                        th:each="err: ${#fields.errors('description')}" th:utext="${err}"></span>
                                </div>
                            </div>
                        </div>

                        <!-- SECRET -->
                        <div class="row">
                            <div class="col-6 my-1">
                                <div class="form-group custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" name="secret" id="secret" th:field="*{secret}">
                                    <label class="custom-control-label form-control-label" for="secret" th:text="#{survey.secret}"></label>
                                    <span th:if="${#fields.hasErrors('secret')}" th:each="err: ${#fields.errors('secret')}" th:utext="${err}"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!--  DATES -->
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="startDate" class="form-control-label" th:text="#{survey.startDate}"></label>
                                    <input type="date" name="startDate" th:field="*{startDate}" class="form-control"/>
                                    <span th:if="${#fields.hasErrors('startDate')}" th:each="err: ${#fields.errors('startDate')}" th:utext="${err}"></span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <!-- TO DO: datetime-local type -->
                                    <label for="endDate" class="form-control-label" th:text="#{survey.endDate}"></label>
                                    <input type="date" name="endDate" th:field="*{endDate}" class="form-control"/>
                                    <span th:if="${#fields.hasErrors('endDate')}" th:each="err: ${#fields.errors('endDate')}" th:utext="${err}"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Icon container -->
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label class="form-control-label mb-0">Icon</label>

                                    <div class="custom-file" th:if="${survey.id == null}">
                                        <input type="file" class="custom-file-input" id="iconfile" name="iconfile" th:value="${iconfile}" accept="image/*" />
                                        <label id="survey_icon" class="custom-file-label text-truncate" for="customIcon">Choose file...</label>
                                    </div>
                                    <!--Update case -->
                                    <div class="custom-file" th:if="${survey.id != null}">
                                        <input type="file" class="custom-file-input" id="iconfile" name="iconfile" th:value="${iconfile}"
                                            accept="image/*" />
                                        <input type="text" class="hidden" id="icon" name="icon" th:field="*{icon}"/>
                                        <label id="survey_icon" class="custom-file-label text-truncate" for="customIcon" th:text="${survey.icon != null ? survey.icon.name : 'Choose file...'}"></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Error container -->
                        <div class="row">
                            <div class="col-8">
                                <span id="errors" class="text-danger text-sm hidden"></span>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-link text-danger" data-dismiss="modal">[[#{common.cancel}]]</button>
                        <button id="survey_submit" type="submit" class="btn btn-sm btn-primary rounded-pill" th:text="#{common.submit}"></button>
                    </div>

                </form>

            </div>

        </div>
        <script th:inline="javascript">
            $("#iconfile").change(function () {
                $("#survey_icon").text(this.files[0].name);
            });
            $("#iconfile").hover(function () {
                $(this).css("cursor", "pointer");
            });
            $('#survey_form').submit(function (e) {
                let err = false;
                let data = $(this).serializeArray();
                let startDate = data.find((elem) => elem.name == 'startDate');
                let endDate = data.find((elem) => elem.name == 'endDate');
                let today = new Date().setHours(0, 0, 0, 0);
                let ext = $('#iconfile').val().split('.').pop().toLowerCase();
                // Dates validation
                if (startDate.value !== "" && (new Date(startDate.value) < today)) {
                    $("#errors").text([[#{startdate.lower}]]);
                    err = true;
                }
                if (endDate.value !== "" && (new Date(endDate.value) < today)) {
                    $("#errors").text([[#{enddate.lower}]]);
                    err = true;
                }
                if (startDate.value !== "" && endDate.value !== "" && (startDate.value > endDate.value)) {
                    $("#errors").text([[#{startdate.greater}]]);
                    err = true;
                }
                // File validation
                if (ext !== "" && $.inArray(ext, ['png', 'jpg', 'jpeg']) == -1) {
                    err = true;
                    $("#errors").text([[#{file.invalid}]]);
                }
                if (err) {
                    e.preventDefault();
                    $("#errors").show();
                } 
            });
        </script>
    </div>
    
</body>
</html>